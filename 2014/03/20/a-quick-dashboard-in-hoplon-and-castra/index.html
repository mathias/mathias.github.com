<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="The blog of Matt Gauger, a programmer, maker, cyclist, reader, and boatbuilder. Lisp machines and chording keybords in the present, not the past."><title> A quick dashboard in Hoplon &amp; Castra &middot; Matt Gauger</title><link rel="stylesheet" href="/css/main.css"><link rel='alternate' type='application/atom+xml' href='/atom.xml'></head><body><nav class="nav"><div class="nav-container"> <a href="https://blog.mattgauger.com"><h2 class="nav-title">Matt Gauger</h2></a><ul><li><a href="/about">About</a></li><li><a href="/archives">Blog Archives</a></li><li><a href="/open-source">Open Source</a></li></ul></div></nav><main><div class="post"><div class="post-info"> <span>Written by</span> Matt Gauger <br> <span>on&nbsp;</span><time datetime="2014-03-20 13:29:00 -0500">March 20, 2014</time></div><h1 class="post-title">A quick dashboard in Hoplon &amp; Castra</h1><div class="post-line"></div><p><em>Note:</em> I began writing a much longer blog post that went into a ton of detail about how to build an app dashboard that used Hoplon and Castra. The kind of dashboard that just consumes JSON API endpoints from another app or other data sources. Such dashboards update on the fly in the browser. Many apps these days need a dashboard like this to monitor stats: worker job queues, database size, average response times, etc.</p><p>Rather than that long blog post, I wanted to simply show the steps I would take to build such a dashboard with <a href="http://hoplon.io">Hoplon</a> and <a href="https://github.com/tailrecursion/castra">Castra</a>. I won’t go into detail here or explain either Hoplon or Castra — go read on your own first, and also look into <a href="https://github.com/tailrecursion/boot">boot</a>, the build tool this uses.</p><p>If you want to follow along, I’ve provided a <a href="https://github.com/mathias/gleam">repo</a>. The <a href="https://github.com/mathias/gleam/blob/30b4976b313c950c6cc97e64c65036eb21d75378/README.md">README</a> has instructions for getting setup. Assuming you have boot installed, you can just run <code class="language-plaintext highlighter-rouge">boot gleam-app</code> to get started.</p><p>So here’s how I’d build up a dashboard, in several iterations:</p><h2 id="static-data-in-the-browser">Static data in the browser:</h2><p>First, we get some data into the HTML using Hoplon cells, in <code class="language-plaintext highlighter-rouge">index.html</code>:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/hoplon"</span><span class="nt">&gt;</span>
  <span class="p">(</span><span class="nx">page</span> <span class="dl">"</span><span class="s2">index.html</span><span class="dl">"</span>
    <span class="p">(:</span><span class="nx">refer</span><span class="o">-</span><span class="nx">clojure</span> <span class="p">:</span><span class="nx">exclude</span> <span class="p">[</span><span class="nx">nth</span><span class="p">])</span>
    <span class="p">(:</span><span class="nx">require</span>
      <span class="p">[</span><span class="nx">tailrecursion</span><span class="p">.</span><span class="nx">hoplon</span><span class="p">.</span><span class="nx">reload</span> <span class="p">:</span><span class="nx">refer</span> <span class="p">[</span><span class="nx">reload</span><span class="o">-</span><span class="nx">all</span><span class="p">]]))</span>

  <span class="p">(</span><span class="nx">def</span> <span class="nx">articles</span> <span class="p">{:</span><span class="nx">total</span> <span class="mi">422</span>
                 <span class="p">:</span><span class="nx">ingested</span> <span class="mi">419</span>
                 <span class="p">:</span><span class="nx">fetched</span> <span class="mi">0</span>
                 <span class="p">:</span><span class="nx">errored</span> <span class="mi">0</span>
                 <span class="p">:</span><span class="nx">read</span> <span class="mi">315</span><span class="p">})</span>

  <span class="p">(</span><span class="nx">reload</span><span class="o">-</span><span class="nx">all</span> <span class="mi">25</span><span class="p">)</span>
<span class="nt">&lt;/script&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>gleam<span class="nt">&lt;/title&gt;</span>

    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"app.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/head&gt;</span>

  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;header&gt;</span>
      <span class="nt">&lt;h1&gt;</span>gleam<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h2&gt;</span>Articles<span class="nt">&lt;/h2&gt;</span>
      <span class="nt">&lt;ul&gt;</span>
        <span class="nt">&lt;li&gt;</span>
          <span class="nt">&lt;label&gt;</span>Total:<span class="nt">&lt;/label&gt;&lt;text&gt;</span> ~{(get articles :total)}<span class="nt">&lt;/text&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span>
          <span class="nt">&lt;label&gt;</span>Ingested:<span class="nt">&lt;/label&gt;&lt;text&gt;</span> ~{(get articles :ingested)}<span class="nt">&lt;/text&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span>
          <span class="nt">&lt;label&gt;</span>Fetched:<span class="nt">&lt;/label&gt;&lt;text&gt;</span> ~{(get articles :fetched)}<span class="nt">&lt;/text&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span>
          <span class="nt">&lt;label&gt;</span>Errored:<span class="nt">&lt;/label&gt;&lt;text&gt;</span> ~{(get articles :errored)}<span class="nt">&lt;/text&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span>
          <span class="nt">&lt;label&gt;</span>Read:<span class="nt">&lt;/label&gt;&lt;text&gt;</span> ~{(get articles :read)}<span class="nt">&lt;/text&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;footer&gt;</span>
    <span class="nt">&lt;/footer&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div><p>You’ll want to <code class="language-plaintext highlighter-rouge">git reset --hard 69b070</code> to get to this point.</p><h2 id="move-the-data-to-clojurescript">Move the data to ClojureScript:</h2><p>In <code class="language-plaintext highlighter-rouge">src/cljs/gleam/rpc.cljs</code>:</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">gleam.rpc</span><span class="w">
  </span><span class="p">(</span><span class="no">:require-macros</span><span class="w">
    </span><span class="p">[</span><span class="n">tailrecursion.javelin</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">defc</span><span class="w"> </span><span class="n">defc=</span><span class="w"> </span><span class="n">cell=</span><span class="p">]])</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">clojure.set</span><span class="w">           </span><span class="no">:as</span><span class="w"> </span><span class="n">cs</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="n">clojure.string</span><span class="w">        </span><span class="no">:as</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="n">tailrecursion.javelin</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">cell</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">tailrecursion.castra</span><span class="w">  </span><span class="no">:as</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">mkremote</span><span class="p">]]))</span><span class="w">

</span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="n">cljs.core/*print-fn*</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">.log</span><span class="w"> </span><span class="n">js/console</span><span class="w"> </span><span class="n">%</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">articles</span><span class="w"> </span><span class="p">{</span><span class="no">:total</span><span class="w"> </span><span class="mi">422</span><span class="w">
               </span><span class="no">:ingested</span><span class="w"> </span><span class="mi">419</span><span class="w">
               </span><span class="no">:fetched</span><span class="w"> </span><span class="mi">0</span><span class="w">
               </span><span class="no">:errored</span><span class="w"> </span><span class="mi">0</span><span class="w">
               </span><span class="no">:read</span><span class="w"> </span><span class="mi">315</span><span class="p">})</span><span class="w">
</span></code></pre></div></div><p>And take out the <code class="language-plaintext highlighter-rouge">(def articles…)</code> from <code class="language-plaintext highlighter-rouge">index.html.hl</code>. After boot recompiles everything, you should still see the data in the page.</p><p>To get to this point, you can run <code class="language-plaintext highlighter-rouge">git reset --hard d63f299</code>.</p><h2 id="move-the-data-to-the-server-side">Move the data to the server side</h2><p>Change <code class="language-plaintext highlighter-rouge">src/cljs/gleam/rpc.cljs</code> again, this time to make a remote call for data:</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">gleam.rpc</span><span class="w">
  </span><span class="p">(</span><span class="no">:require-macros</span><span class="w">
    </span><span class="p">[</span><span class="n">tailrecursion.javelin</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">defc</span><span class="w"> </span><span class="n">defc=</span><span class="w"> </span><span class="n">cell=</span><span class="p">]])</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.set</span><span class="w">           </span><span class="no">:as</span><span class="w"> </span><span class="n">cs</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">clojure.string</span><span class="w">        </span><span class="no">:as</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">tailrecursion.javelin</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">cell</span><span class="p">]]</span><span class="w">
            </span><span class="p">[</span><span class="n">tailrecursion.castra</span><span class="w">  </span><span class="no">:as</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">mkremote</span><span class="p">]]))</span><span class="w">

</span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="n">cljs.core/*print-fn*</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">.log</span><span class="w"> </span><span class="n">js/console</span><span class="w"> </span><span class="n">%</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">defc</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="p">{</span><span class="no">:articles</span><span class="w"> </span><span class="p">{}})</span><span class="w">
</span><span class="p">(</span><span class="nf">defc</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">nil</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">defc</span><span class="w"> </span><span class="n">loading</span><span class="w"> </span><span class="p">[])</span><span class="w">

</span><span class="p">(</span><span class="nf">defc=</span><span class="w"> </span><span class="n">articles</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="no">:articles</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">get-state</span><span class="w">
  </span><span class="p">(</span><span class="nf">mkremote</span><span class="w"> </span><span class="ss">'gleam.api.gleam/get-state</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">loading</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">get-state</span><span class="p">)</span><span class="w">
  </span><span class="c1">;; Check every second for new data</span><span class="w">
  </span><span class="p">(</span><span class="nf">js/setInterval</span><span class="w"> </span><span class="n">get-state</span><span class="w"> </span><span class="mi">1000</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p>On the backend, we need something like this in <code class="language-plaintext highlighter-rouge">src/castra/gleam/api/gleam.clj</code>:</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">gleam.api.gleam</span><span class="w">
  </span><span class="p">(</span><span class="no">:refer-clojure</span><span class="w"> </span><span class="no">:exclude</span><span class="w"> </span><span class="p">[</span><span class="k">defn</span><span class="p">])</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">tailrecursion.castra</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="k">defn</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">*session*</span><span class="p">]]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">articles</span><span class="w"> </span><span class="p">{</span><span class="no">:total</span><span class="w"> </span><span class="mi">422</span><span class="w">
               </span><span class="no">:ingested</span><span class="w"> </span><span class="mi">419</span><span class="w">
               </span><span class="no">:fetched</span><span class="w"> </span><span class="mi">0</span><span class="w">
               </span><span class="no">:errored</span><span class="w"> </span><span class="mi">0</span><span class="w">
               </span><span class="no">:read</span><span class="w"> </span><span class="mi">315</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">get-state</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">{</span><span class="no">:articles</span><span class="w"> </span><span class="n">articles</span><span class="p">})</span><span class="w">
</span></code></pre></div></div><p>The Hoplon HTML file changes in the script tag at the top of <code class="language-plaintext highlighter-rouge">index.html</code> to use the new ClojureScript remote call and start up the polling:</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">&lt;script</span><span class="w"> </span><span class="n">type=</span><span class="s">"text/hoplon"</span><span class="nb">&gt;</span><span class="w">
  </span><span class="p">(</span><span class="nf">page</span><span class="w"> </span><span class="s">"index.html"</span><span class="w">
    </span><span class="p">(</span><span class="no">:refer-clojure</span><span class="w"> </span><span class="no">:exclude</span><span class="w"> </span><span class="p">[</span><span class="nb">nth</span><span class="p">])</span><span class="w">
    </span><span class="p">(</span><span class="no">:require</span><span class="w">
      </span><span class="p">[</span><span class="n">gleam.rpc</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">gleam</span><span class="p">]</span><span class="w">
      </span><span class="p">[</span><span class="n">tailrecursion.hoplon.reload</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">reload-all</span><span class="p">]]))</span><span class="w">

  </span><span class="p">(</span><span class="nf">defc=</span><span class="w"> </span><span class="n">articles</span><span class="w"> </span><span class="n">gleam/articles</span><span class="p">)</span><span class="w">

  </span><span class="p">(</span><span class="nf">gleam/init</span><span class="p">)</span><span class="w">
</span><span class="n">&lt;/script&gt;</span><span class="w">
</span></code></pre></div></div><p>To get to this point in the example repo, you can do <code class="language-plaintext highlighter-rouge">git reset --hard 0bad1e5</code>.</p><h2 id="real-time-data">Real time data</h2><p>The last step that I will show is to verify that we are in fact getting regular updates of data from the back end.</p><p>Change your Castra Clojure file to look like this:</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">gleam.api.gleam</span><span class="w">
  </span><span class="p">(</span><span class="no">:refer-clojure</span><span class="w"> </span><span class="no">:exclude</span><span class="w"> </span><span class="p">[</span><span class="k">defn</span><span class="p">])</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">tailrecursion.castra</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="k">defn</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">*session*</span><span class="p">]]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">articles</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">ingested</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span><span class="w">
        </span><span class="n">fetched</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span><span class="w">
        </span><span class="n">errored</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span><span class="w">
        </span><span class="nb">read</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">300</span><span class="p">)]</span><span class="w">
    </span><span class="p">{</span><span class="no">:total</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">ingested</span><span class="w"> </span><span class="n">fetched</span><span class="w"> </span><span class="n">errored</span><span class="w"> </span><span class="nb">read</span><span class="p">)</span><span class="w">
     </span><span class="no">:ingested</span><span class="w"> </span><span class="n">ingested</span><span class="w">
     </span><span class="no">:fetched</span><span class="w"> </span><span class="n">fetched</span><span class="w">
     </span><span class="no">:errored</span><span class="w"> </span><span class="n">errored</span><span class="w">
     </span><span class="no">:read</span><span class="w"> </span><span class="nb">read</span><span class="p">}))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">get-state</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">{</span><span class="no">:articles</span><span class="w"> </span><span class="p">(</span><span class="nf">articles</span><span class="p">)})</span><span class="w">
</span></code></pre></div></div><p>To get to this point, you can do a <code class="language-plaintext highlighter-rouge">git reset --hard f19325</code></p><h2 id="talking-to-a-remote-service">Talking to a remote service.</h2><p>The last step here is left as an exercise for the reader. You can imagine replacing the <code class="language-plaintext highlighter-rouge">articles</code> function in <code class="language-plaintext highlighter-rouge">src/castra/gleam/api/gleam.clj</code> with something that polls a remote JSON API for data. Or you could look at my social news app <a href="http://github.com/mathias/gnar">gnar</a> for inspiration on using a Postgres database for data.</p><p>I hope to finish up a post with full explanations soon. Castra is relatively new, and it’s worth explaining how some of the pieces fit together. My explanation should include more complicated interaction. like user authentication. I will be publishing that blog post after I get back from <a href="http://clojurewest.org">ClojureWest</a> next week!</p><p>Let me know what you thought of this post by shooting me an <a href="mailto:contact@mattgauger.com">email</a>. I’d love to hear from you.</p></div><div class="pagination"> <a href="/2014/03/30/clojure-data-science-ingesting-your-gmail-inbox/" class="left arrow">&#8592;</a> <a href="/2014/03/14/agile-data-science-review-and-thoughts/" class="right arrow">&#8594;</a> <a href="#" class="top">Top</a></div></main><footer> <span> &copy; <time datetime="2025">2025</time> Matt Gauger. </span> <a rel="me" href="https://mastodon.xyz/@mathiasx">@mathiasx@mastodon.xyz</a></footer></body></html>
