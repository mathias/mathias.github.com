
<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Unit testing the Arduino with Greatest - blog.mattgauger.com</title>
    <meta name="author" content="Matt Gauger">

    
    <meta name="description" content="Unit Testing the Arduino With Greatest When I write code for work, we often write unit tests and other types of tests first for a small piece of &hellip;">
    

    <link href="/atom.xml" rel="alternate" title="blog.mattgauger.com" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    

</head>


<body>
  <header class="inner"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a href="/" class="brand">blog.mattgauger.com</a>

      <div class="nav-collapse">
        <nav class="menu left"><ul class="nav">
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Blog Archives</a></li>
  <li><a href="/presentations">Presentations</a></li>
  
  <li class="divider-vertical"></li>
  <li><a class="rss" href="/atom.xml" title="RSS">RSS</a></li>
  
</ul>
</nav>
        <div class="right">
          <form class="navbar-search pull-right" action="http://google.com/search" method="get">
            <input class="input-medium search-query span2" type="text" name="q" results="0" placeholder="Search">
            <input type="hidden" name="q" value="site:blog.mattgauger.com">
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
</header>
  <div class="container bottom-left-rounded-corner bottom-right-rounded-corner" id="page-container">
    <div class="row">
  <div class="span8 offset2" id="content">
    <article class="post">
    <h1 class="title">Unit Testing the Arduino With Greatest</h1>
    <div class="entry"><p>When I write code for work, we often write unit tests and other types of tests first for a small piece of functionality, then implement that functionality, making the tests pass. And then we iterate. This is known as test-driven development. Tests can be written after the fact, too, and they are just as valuable. A suite of tests helps to ensure that behavior doesn&#8217;t change when unrelated code changes, and that we don&#8217;t introduce regressions in behavior by trying to add new functionality to our existing code.</p>

<p>Unit tests test specific functionality of code, in something of a vacuum. That is, with unit tests, we don&#8217;t want to test the code&#8217;s integration with other pieces of code, but merely its own behavior. Its inputs and outputs, and how it handles those inputs and outputs. One way to think about it is that we&#8217;re going to perform an experiment. Our hypothesis is that this small piece of code, usually a single function or method, behaves the way we believe it does. To confirm or deny that hypothesis, we put the piece of code under a test that holds all variables fairly constant and allow one independent variable for the functionality we&#8217;re testing. Whether or not that one factor behaves as we expected is the unit test.</p>

<p>When we write code for the Arduino, it is usually very simple. Let&#8217;s look at Blink example code that ships on most Arduinos:</p>

<script src="https://gist.github.com/mathias/6217579.js"></script>


<p>As you can see, there&#8217;s three pieces to an Arduino program: creating globals like the <code>ledPin</code> variable, the <code>setup</code> function, and the <code>loop</code> function. And that&#8217;s all there is to most Arduino programs. Notice that the <code>loop</code> function in particular is quite imperative: it&#8217;s going to loop forever, and we specify one thing, then the next, etc. that will be run.</p>

<p>This style of programming Arduinos seems comfortable to a lot of people, and for simple functionality, it is acceptable. To test it, simply upload the code to the Arduino and observe the results. Since all this does is blink an LED, it is fairly easy to verify.</p>

<p>As complexity of an Arduino program grows, however, I like to split out the steps that go into each tick of the <code>loop</code> function into separate functions, and often, split out functions from <code>setup</code> as well for each piece of hardware.</p>

<p>An imaginary Arduino program for a robot might look something like:</p>

<script src="https://gist.github.com/mathias/6217621.js"></script>


<p>Assuming all of the functions like <code>setup_sonars()</code>, <code>check_sonar()</code>, <code>choose_direction()</code> and <code>move()</code> were all defined and worked the way we expected, then this is an improvement in showing the intent of the code. We can glance at the <code>setup</code> and <code>loop</code> part of the code and understand how the robot is supposed to behave. There&#8217;s some implicit state that is being used behind the scenes here to allow the decision made in <code>choose_direction</code> to influence <code>move</code>, but we can get to that later. Of course, the bulk of the Arduino sketch above would still be in there, it would just be encapsulated in those functions that get called.</p>

<p>So what happens when we our Arduino sketch gets complex enough that we cannot easily verify that everything we have written behaves as expected? Not all code that you might want to run on an Arduino is suited to the verify, upload, and then manually test pattern that one does with simple Arduino sketches.</p>

<p>I turned to unit testing because that is one of the best tools in my toolbox. By introducing an unit testing flow to the development of Arduino sketches, I can verify more logic before uploading code to the Arduino, and verify that existing functionality continues to function after I begin adding more features.</p>

<p>On <a href="http://blog.mattgauger.com/blog/2013/08/03/building-a-chording-keyboard-lessons-learned-and-progress-so-far/">my chording keyboard project</a>, the code is quickly growing beyond what can reasonably be written in a simple Arduino <code>loop()</code> function. The scroll wheel alone has 3 pins for input, 1 for output (an LED), and sends mouse signals to the host OS. And, it must do this while the rest of the keyboard deals with a sliding buffer for matching chord patterns and while different modes come into play that affect other parts of the keyboard&#8217;s behavior. Suffice to say, I want to extract and simplify the scroll wheel&#8217;s code and verify that it works. Then, I can move on to other pieces and be reasonably sure that the scroll wheel will continue to function.</p>

<p>But the whole scroll wheel might be a little too big for this blog post. So let&#8217;s just focus on the pushbutton and the LED, and let&#8217;s say that when the pushbutton is pressed, we want to send the middle-click signal to the OS, as well as flash the LED on and off quickly. Not overly complex behavior, but it is enough for us to work with for the purposes of this blog post. Here&#8217;s what that sketch looks like, with all the distractions of the rest of the keyboard removed:</p>

<script src="https://gist.github.com/mathias/6217894.js"></script>


<p>Let&#8217;s do a quick refactoring to extract our setup and functionality into functions:</p>

<script src="https://gist.github.com/mathias/6217926.js"></script>


<p>The next step is to extract our functionality out into what Arduino calls a <a href="http://arduino.cc/en/Hacking/LibraryTutorial">library</a>. Remember, Arduino code is just C++, so what we&#8217;re really going to do is extract this functionality out into a <strong>class</strong>. Following the libraries guide from that link, we extract our code out into a new header file:</p>

<script src="https://gist.github.com/mathias/6217939.js"></script>

</div>

    <div class="meta">
        <div class="author">
  

<span class="byline author vcard">Posted by <span class="fn">Matt Gauger</span>.</span>
</div>
        <div class="date">












<time datetime="2013-08-12T22:04:00-05:00" pubdate  data-updated="true" >Aug 12<span>th</span>, 2013</time>.</div>
        <div class="tags">

</div>
    </div>
</article>
  </div>
</div>

    <hr />
	  <footer class="footer"><div class="row">
  <div class="offset2 span2">
    <img src="/images/mathiasx.jpg" alt="portrait">
  </div>
  <div class="span3">
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/StillImage" property="dct:title" rel="dct:type">mathias.github.com</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://mathias.github.com" property="cc:attributionName" rel="cc:attributionURL">Matt Gauger</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.<br />

  </div>
  <div class="offset1 span3">
    <ul class="nav nav-list">
      <li><a href="https://twitter.com/mathiasx">Twitter</a></li>
      <li><a href="https://github.com/mathias">Github</a></li>
      <li><a href="/presentations">Presentations</a></li>
      <li><a href="http://hackz0r.tumblr.com">hackz0r links (tumblog)</a></li>
      <li><a href="/atom.xml">Atom feed</a></li>
    </ul>
  </div>
</div>
</footer>
  </div>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script src="/javascripts/bootstrap-alert.js"></script>
<script src="/javascripts/bootstrap-button.js"></script>
<script src="/javascripts/bootstrap-collapse.js"></script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38944731-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
