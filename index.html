
<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>blog.mattgauger.com</title>
    <meta name="author" content="Matt Gauger">

    
    <meta name="description" content="Clojure Code Quality Tools I work with many programming languages on a daily basis. As a polyglot programmer, I&#8217;ve come to appreciate tools &hellip;">
    

    <link href="/atom.xml" rel="alternate" title="blog.mattgauger.com" type="application/atom+xml">
    <link rel="canonical" href="">
    <link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>


<body>
  <header class="inner"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a href="/" class="brand">blog.mattgauger.com</a>

      <div class="nav-collapse">
        <nav class="menu left"><ul class="nav">
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Blog Archives</a></li>
  <li><a href="/open-source">Open Source</a></li>
  <li><a href="/presentations">Presentations</a></li>
  
  <li class="divider-vertical"></li>
  <li><a class="feed" href="http://feeds.feedburner.com/MattGaugerBlog" title="Atom XML/RSS Feed">Atom Feed</a></li>
  
</ul>
</nav>
        <div class="right">
          <form class="navbar-search pull-right" action="http://google.com/search" method="get">
            <input class="input-medium search-query span2" type="text" name="q" results="0" placeholder="Search">
            <input type="hidden" name="q" value="site:blog.mattgauger.com">
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
</header>
  <div class="container bottom-left-rounded-corner bottom-right-rounded-corner" id="page-container">
    <div class="row">
  <article class="page span8 offset2">
    
    


  <article class="post">
    
    <h1 class="title"><a href="/blog/2014/09/15/clojure-code-quality-tools/">Clojure Code Quality Tools</a></h1>
    <div class="entry">
        <p>I work with many programming languages on a daily basis. As a polyglot programmer, I&#8217;ve come to appreciate tools that help me follow best practices. For JavaScript, there&#8217;s the excellent <a href="http://jshint.com/">jshint</a>. When I need to verify some XML, there&#8217;s <a href="http://xmlsoft.org/xmllint.html">xmllint</a>. In a Ruby on Rails project, I can count on the <a href="http://rubygems.org/gems/rails_best_practices">rails_best_practices</a> gem. For Ruby smells, I prefer the combo of <a href="https://github.com/bbatsov/rubocop">rubocop</a>. There&#8217;s tools like <a href="https://github.com/colszowka/simplecov">SimpleCov</a> to measure and show test suite coverage on my Ruby projects. <a href="https://github.com/square/cane">cane</a> helps me to ensure line length, method complexity, and more in my Ruby code. <a href="https://github.com/scrooloose/syntastic">Syntastic</a> helps bring real syntax checking to vim for many langauges. Every day, more open source tools are introduced that help me to improve the quality of the software that I write.</p>

<p>It follows that when I write Clojure code, I want nice tooling to help me manage code quality, namespace management, and out-of-date dependencies. What tools do I use on a day-to-day basis for this? In this post, I&#8217;ll show 5 tools that I use in my workflow every day on Clojure projects, and also provide some other tools for further exploration. Most of these tools exist as plugins to the excellent <a href="http://leiningen.org/">Leiningen</a> tool for Clojure.</p>

<h2>lein deps :tree</h2>

<p>In the past, <code>lein deps</code> was a command that downloaded the correct versions of your project&#8217;s dependencies. Running <code>lein deps</code> is no longer necessary, as each lein command now checks for dependencies before executing. But <code>deps</code> provides an interesting variant for our uses: <code>lein deps :tree</code>.</p>

<p>The <code>:tree</code> keyword at the end instructs lein to print out your project&#8217;s dependencies as a tree. This itself is a good visualization, but not what we&#8217;re looking for. The tree command will first print out any dependencies-of-dependencies which have conflicts with other dependencies. For example, here&#8217;s what <code>lein deps :tree</code> says for one of my projects:</p>

<script src="https://gist.github.com/mathias/8eca3548f751bec6ea55.js"></script>


<p>As you can see, the tool suggests dependencies that request conflicting versions, and how we can modify our <code>project.clj</code> file to resolve those conflicting versions by excluding one or the other. This isn&#8217;t always very useful, but when you run into issues because two different Clojure libraries require two wildly different <code>joda-time</code> versions (a situation I have run into before), it will be good to know what dependencies are causing that issue and how you might go about resolving it.</p>

<p>Note that this functionality disappeared in Leiningen 2.4.3 but is back in 2.5.0, so make sure you run <code>lein upgrade</code>!</p>

<h2><a href="https://github.com/xsc/lein-ancient">lein-ancient</a></h2>

<p>This plugin to <code>lein</code> exists simply to check your project for outdated dependencies. Without <a href="https://github.com/xsc/lein-ancient">lein-ancient</a>, I&#8217;d be unable to keep up with some of the faster-moving libraries in the Java and Clojure world.</p>

<p>After adding ancient to your <code>~/.lein/profiles.clj</code>, running the <code>lein ancient</code> command yields output on the same project as before:</p>

<script src="https://gist.github.com/mathias/bac5e554f971d7aa462f.js"></script>


<p>Whoops! Looks like I haven&#8217;t been keeping up to date with my dependencies. <code>lein ancient</code> makes checking for new dependency versions easy. Further, thanks to the ubiquity of <a href="http://semver.org/">semantic versioning</a> in Clojure projects, it is usually quite safe to bump the minor versions (0.0.x) of dependencies.</p>

<p>You can also use lein-ancient to find outdated lein plugins in your <code>~/.lein/profiles.clj</code> file. Just run it with the <code>profiles</code> argument:</p>

<script src="https://gist.github.com/mathias/02b999542ea837b87e30.js"></script>


<h2><a href="https://github.com/jonase/kibit">lein kibit</a></h2>

<p>As we gain experience and confidence in a programming language, we begin to talk about whether we&#8217;re writing <em>idiomatic</em> code. I&#8217;d argue that idiomatic code is code that accomplishes a goal with proper use of language features, in a way that other developers familiar with that language would understand. A simpler way to say it might be: idiomatic code uses the community-accepted best practices of how to do something.</p>

<p>Clojure&#8217;s design seeks to solve some problems found in older Lisps, as well as add in niceties like complementary predicate functions. A good example of these convenient complementary functions are <code>if</code> and <code>if-not</code>. Clojure also contains several cases of simplification for common usage. For example, when you don&#8217;t need an else clause on an <code>if</code>, you can use the <code>when</code> macro.</p>

<p>Wouldn&#8217;t it be great if there was someone who was well-versed in Clojure idioms pairing with you and offering suggestions? That&#8217;s exactly what <a href="https://github.com/jonase/kibit">kibit</a> does.</p>

<p>Running against a project I&#8217;d set up to contain some smells, <code>lein kibit</code> found:</p>

<script src="https://gist.github.com/mathias/fc0d446aeb90f44a6731.js"></script>


<p>These kinds of small improvements are all over our Clojure projects. They&#8217;re not show-stopper bugs, but they&#8217;re small places for improvement.</p>

<p>Kibit&#8217;s suggestions are almost always logically equivalent to the original code. Still, I always do some smoke-testing to ensure the code still works after using Kibit&#8217;s suggestion, and it generally does. Problems I frequently fix with Kibit are replacing <code>if</code> statements with the <code>when</code> macro, as well as places where the code checks for empty seqs, or that I can simplify nil checks.</p>

<p>You can point lein kibit at a specific namespace by appending the path, like this: <code>lein kibit src/foo/bar.clj</code></p>

<p>Kibit catches many cases where there is a more-idiomatic way to express what you are trying to do. I recommend running it often. In fact, it&#8217;s possible to use <a href="https://github.com/jonase/kibit#usage-from-inside-emacs">kibit in your emacs buffers</a> if you want it to be that much more convenient and real-time.</p>

<h2><a href="https://github.com/jonase/eastwood">Eastwood</a></h2>

<p>For linting Clojure code, there&#8217;s Eastwood. It is similar in functionality to Kibit, bit will catch different issues than Kibit. Built on two interesting Clojure projects: <a href="https://github.com/clojure/tools.analyzer">tools.analyzer</a> and <a href="https://github.com/clojure/tools.analyzer.jvm">tools.analyzer.jvm</a>, Eastwood does a powerful examination of your code inside the JVM. It is worth highlighting that since Eastwood loads your code to analyze it, it might trigger any side effects that happen when your code loads: writing files, modifying databases, etc. Note that it only loads the code; it does not execute it.</p>

<p>After adding <code>eastwood</code> to your lein <code>profiles.clj</code>, simply run: <code>lein eastwood</code> and you will see output like:</p>

<script src="https://gist.github.com/mathias/b93cea02293eac933bee.js"></script>


<p>That&#8217;s a lot of problems for a simple file! Notice how one mistake got caught for two reasons: A misplaced docstring (placed after the arguments vector) becomes just a string in the function body that will be thrown away.</p>

<p>Another nice catch that Eastwood provides is detecting the redefinition of the var <code>qux</code> in the file.</p>

<p>But Eastwood covers a lot more cases than just vars being def&#8217;d more than once. See the <a href="https://github.com/jonase/eastwood#whats-there">full list</a> to find out what else it does. There&#8217;s a few linters that are disabled by default, but they might make sense to enable for your project.</p>

<p>Frequently running lint tools can help prevent subtle problems that come from code that looks correct but contains some small error. Eastwood is less concerned with style than tools like JSHint are, but we have other tools that cover stylistic concerns.</p>

<h2><a href="https://github.com/dakrone/lein-bikeshed">lein bikeshed</a></h2>

<p>This is a relative newcomer to my own tool set. <a href="https://github.com/dakrone/lein-bikeshed">lein bikeshed</a> has features related to the low-hanging fruit in our Clojure code: lines longer than 80 characters, blank lines at ends of files, and more. It will also tell you what percentage of functions have docstrings. Like other tools mentioned here, it is a lein plugin that you add to your <code>profiles.clj</code>.</p>

<p>A run of <code>lein bikeshed</code> on its own source (which purposefully includes some code designed to fail) looks like this:</p>

<script src="https://gist.github.com/mathias/271e06ebce8fe6428b83.js"></script>


<p>Bikeshed might give a lot of output for your existing projects, but the warnings are worth investigating and addressing. You can always silence the long-lines warning if it doesn&#8217;t matter to you with the <code>-m</code> command line argument.</p>

<h2>Tying it all together with a Lein alias</h2>

<p>Wouldn&#8217;t it be great to run all these tools frequently, so that you can check for as many problems as possible? Well, you can, with a lein alias. (The lein wiki documents aliases in the <a href="https://github.com/technomancy/leiningen/blob/stable/sample.project.clj#L195-L211">lein sample.project.clj</a>.)</p>

<p>In <code>~/.lein/profiles.clj</code>, inside your <code>:user</code> map, add the line:</p>

<script src="https://gist.github.com/mathias/eef9f3f3e9e0ba40cb78.js"></script>


<p>Now, when you want to run all these tools at once on a project, you simply invoke <code>lein omni</code>. I use this alias on all my Clojure(Script) projects. I have grown accustomed to seeing the kinds of output that a clean Clojure project will have.</p>

<p>It&#8217;s worth noting that I don&#8217;t run Eastwood unless it is necessary for the project. When it is necessary, I override the alias in the project&#8217;s <code>project.clj</code> to run Eastwood as well.</p>

<p>This command can take some time to complete, but with an alias we&#8217;re only spinning up lein once.</p>

<h2>And a bash alias</h2>

<p>The output of <code>lein omni</code> can be long, which can either result in a lot of scrolling or neglecting to run the command due to the inconvenience. To help manage the length of the output, I&#8217;ve created a bash alias that runs the plugins and pipes them to less.</p>

<p>My personal bash alias also runs midje at the end. You can choose whether to run the tests for your own alias. That&#8217;s just my personal preference.</p>

<script src="https://gist.github.com/mathias/8b6a0040fcd7e4ae890f.js"></script>


<p>Note that just like running the lein alias above, this may take a bit of time. Since we&#8217;re piping it to <code>less</code>, it might take awhile before <code>less</code> receives output. While it is still running, output will periodically show up at the bottom of the <code>less</code> buffer. You can use both Emac&#8217;s and vim&#8217;s movement commands in <code>less</code> to advance the buffer. I find <code>less</code> to be more manageable for scrolling through output than switching to <code>tmux</code>&#8217;s history scrolling mode.</p>

<h2>Managing your namespaces: <a href="https://github.com/technomancy/slamhound">lein slamhound</a></h2>

<p>Namespace management often becomes an issue on nontrivial Clojure projects. Actively developing a project means managing the functions we pull in from other namespaces and from libraries. These require statements can often get out of date. Often, they&#8217;re either missing namespaces that are needed, or containing requirements for old functions that are no longer used in the current code.</p>

<p><a href="https://github.com/technomancy/slamhound">slamhound</a> is a tool that can help to manage dependencies in your namespaces. It knows how to require and import Clojure and Java dependencies, and can remove stale requires that are no longer necessary. Slamhound can often fix missing requires for functions that it can resolve.</p>

<p><strong>Note: slamhound rewrites the namespace macros in your project&#8217;s .clj files!</strong> I recommend only running it on code that&#8217;s committed to git (or whatever you use as a VCS) so that you can review and  rollback any changes it makes.</p>

<p>The most basic way to use slamhound is to add it to your <code>~/.lein/profiles.clj</code> as a dependency. Then add this alias:</p>

<script src="https://gist.github.com/mathias/f3799e60c63b0aebf17e.js"></script>


<p>Now you can use slamhound on a project by running <code>lein slamhound</code> in the project&#8217;s directory. There&#8217;s also REPL and Emacs support, which you can learn more about in the <a href="https://github.com/technomancy/slamhound#repl-usage">slamhound README</a>.</p>

<h2>Measuring test coverage with <a href="https://github.com/lshift/cloverage">cloverage</a></h2>

<p>It is often claimed that less unit testing is necessary in Clojure because Clojure is functional and makes use of immutable data structures. And it is true that with functional programming, most tests are simple: given some input, the output should be a certain value.</p>

<p>Some would even argue that Clojure functions should be well-factored enough into simple functions that the behavior of the function is apparent and requires no tests. Still others maintain that developing in the REPL is as good as writing unit tests, since functions are constantly evaluated and integrated with this style of development.</p>

<p>That said, there&#8217;s still mutable Java code to interop with, there&#8217;s still the necessary evil of functions with side effects, and we might want to check the <em>structure</em> of the data we&#8217;re producing in our functions rather than the value of it. For all those reasons and to check that I don&#8217;t introduce regressions, I tend to write unit tests in Clojure.</p>

<p>This blog post isn&#8217;t a platform to argue for or against testing Clojure. But when you do test, you may wonder how to tell how much test coverage your test suite has. How do we know at a glance what percentage of our namespaces is being tested? And how do we find lines that are never being exercised in our tests? After all, we can&#8217;t improve what we don&#8217;t measure.</p>

<p>That&#8217;s where <a href="https://github.com/lshift/cloverage">cloverage</a> comes in. Cloverage is another lein plugin, so it gets added to <code>~/.lein/profiles.clj</code> like the others. Then run <code>lein cloverage</code> in your project; it will run the test suite and generate a coverage report.</p>

<p>The coverage report appears in <code>target/coverage</code> as HTML files, broken down by namespace.</p>

<p>You can still use Cloverage even if you don&#8217;t use <code>clojure.test</code>. I use <a href="https://github.com/marick/Midje">midje</a> in most of my tests. To use Cloverage in those situations, wrap your tests in a <code>deftest</code>.</p>

<p>Since <code>deftest</code> has a hyphenated Clojure keyword as its identifier, and Midje facts have a string as an identifier, I&#8217;ve come to use the <code>deftest</code> to group related tests together. Usually this means naming the group of tests after the function I&#8217;m testing. Then I name Midje facts after the situation that the fact exercises. This makes sense to me because it fits well with the hierarchy of rspec unit tests in Ruby.</p>

<p>Here&#8217;s an example of using this approach:</p>

<script src="https://gist.github.com/mathias/94e1a4d7b8bce7c02e23.js"></script>


<p>Cloverage also outputs a <code>coverage.txt</code> file that might be useful for use with services like <a href="http://coveralls.io">Coveralls</a>. I haven&#8217;t used this, so I can&#8217;t comment on its usefulness.</p>

<p>If you&#8217;re using <a href="https://github.com/slagyr/speclj">speclj</a> for your tests, you might run into some issues getting Cloverage to play nice. I don&#8217;t use speclj often, so when I couldn&#8217;t get it to work with Cloverage, I didn&#8217;t pursue the issue.</p>

<h2>Final Thoughts</h2>

<p>In this post, I covered 5 tools to add to your workflow all the time, and some others that might be useful in certain cases. I&#8217;m sure there&#8217;s more tools out there that are useful that I don&#8217;t know about, and I&#8217;d love to hear about them.</p>

<p>I&#8217;m also thinking about writing some posts about other development tools that I use, particularly how I use <a href="https://github.com/marick/midje">midje</a> to test, and how you can benchmark code with <a href="https://github.com/davidsantiago/perforate">perforate</a>. If you&#8217;re interested in those topics, get in touch and let me know.</p>

<p>Have fun and enjoy your cleaner codebase with these tools in your tool belt!</p>

<hr />

<p>Interested in commenting or contacting me? Send an email to <a href="mailto:contact@mattgauger.com">contact@mattgauger.com</a>. Thanks!</p>

        
        
    </div>

    <div class="meta">
        <div class="author">
  

<span class="byline author vcard">Posted by <span class="fn">Matt Gauger</span>.</span>
</div>
        <div class="date">












<time datetime="2014-09-15T13:39:00-05:00" pubdate  data-updated="true" >Sep 15<span>th</span>, 2014</time>.</div>
        <div class="tags">

</div>
    </div>

  </article>


  <article class="post">
    
    <h1 class="title"><a href="/blog/2014/09/15/clojure-code-quality-tools/">Clojure Code Quality Tools</a></h1>
    <div class="entry">
        <p>I work with many programming languages on a daily basis. As a polyglot programmer, I&#8217;ve come to appreciate tools that help me follow best practices. For JavaScript, there&#8217;s the excellent <a href="http://jshint.com/">jshint</a>. When I need to verify some XML, there&#8217;s <a href="http://xmlsoft.org/xmllint.html">xmllint</a>. In a Ruby on Rails project, I can count on the <a href="http://rubygems.org/gems/rails_best_practices">rails_best_practices</a> gem. For Ruby smells, I prefer the combo of <a href="https://github.com/bbatsov/rubocop">rubocop</a>. There&#8217;s tools like <a href="https://github.com/colszowka/simplecov">SimpleCov</a> to measure and show test suite coverage on my Ruby projects. <a href="https://github.com/square/cane">cane</a> helps me to ensure line length, method complexity, and more in my Ruby code. <a href="https://github.com/scrooloose/syntastic">Syntastic</a> helps bring real syntax checking to vim for many langauges. Every day, more open source tools are introduced that help me to improve the quality of the software that I write.</p>

<p>It follows that when I write Clojure code, I want nice tooling to help me manage code quality, namespace management, and out-of-date dependencies. What tools do I use on a day-to-day basis for this? In this post, I&#8217;ll show 5 tools that I use in my workflow every day on Clojure projects, and also provide some other tools for further exploration. Most of these tools exist as plugins to the excellent <a href="http://leiningen.org/">Leiningen</a> tool for Clojure.</p>

<h2>lein deps :tree</h2>

<p>In the past, <code>lein deps</code> was a command that downloaded the correct versions of your project&#8217;s dependencies. Running <code>lein deps</code> is no longer necessary, as each lein command now checks for dependencies before executing. But <code>deps</code> provides an interesting variant for our uses: <code>lein deps :tree</code>.</p>

<p>The <code>:tree</code> keyword at the end instructs lein to print out your project&#8217;s dependencies as a tree. This itself is a good visualization, but not what we&#8217;re looking for. The tree command will first print out any dependencies-of-dependencies which have conflicts with other dependencies. For example, here&#8217;s what <code>lein deps :tree</code> says for one of my projects:</p>

<script src="https://gist.github.com/mathias/8eca3548f751bec6ea55.js"></script>


<p>As you can see, the tool suggests dependencies that request conflicting versions, and how we can modify our <code>project.clj</code> file to resolve those conflicting versions by excluding one or the other. This isn&#8217;t always very useful, but when you run into issues because two different Clojure libraries require two wildly different <code>joda-time</code> versions (a situation I have run into before), it will be good to know what dependencies are causing that issue and how you might go about resolving it.</p>

<p>Note that this functionality disappeared in Leiningen 2.4.3 but is back in 2.5.0, so make sure you run <code>lein upgrade</code>!</p>

<h2><a href="https://github.com/xsc/lein-ancient">lein-ancient</a></h2>

<p>This plugin to <code>lein</code> exists simply to check your project for outdated dependencies. Without <a href="https://github.com/xsc/lein-ancient">lein-ancient</a>, I&#8217;d be unable to keep up with some of the faster-moving libraries in the Java and Clojure world.</p>

<p>After adding ancient to your <code>~/.lein/profiles.clj</code>, running the <code>lein ancient</code> command yields output on the same project as before:</p>

<script src="https://gist.github.com/mathias/bac5e554f971d7aa462f.js"></script>


<p>Whoops! Looks like I haven&#8217;t been keeping up to date with my dependencies. <code>lein ancient</code> makes checking for new dependency versions easy. Further, thanks to the ubiquity of <a href="http://semver.org/">semantic versioning</a> in Clojure projects, it is usually quite safe to bump the minor versions (0.0.x) of dependencies.</p>

<p>You can also use lein-ancient to find outdated lein plugins in your <code>~/.lein/profiles.clj</code> file. Just run it with the <code>profiles</code> argument:</p>

<script src="https://gist.github.com/mathias/02b999542ea837b87e30.js"></script>


<h2><a href="https://github.com/jonase/kibit">lein kibit</a></h2>

<p>As we gain experience and confidence in a programming language, we begin to talk about whether we&#8217;re writing <em>idiomatic</em> code. I&#8217;d argue that idiomatic code is code that accomplishes a goal with proper use of language features, in a way that other developers familiar with that language would understand. A simpler way to say it might be: idiomatic code uses the community-accepted best practices of how to do something.</p>

<p>Clojure&#8217;s design seeks to solve some problems found in older Lisps, as well as add in niceties like complementary predicate functions. A good example of these convenient complementary functions are <code>if</code> and <code>if-not</code>. Clojure also contains several cases of simplification for common usage. For example, when you don&#8217;t need an else clause on an <code>if</code>, you can use the <code>when</code> macro.</p>

<p>Wouldn&#8217;t it be great if there was someone who was well-versed in Clojure idioms pairing with you and offering suggestions? That&#8217;s exactly what <a href="https://github.com/jonase/kibit">kibit</a> does.</p>

<p>Running against a project I&#8217;d set up to contain some smells, <code>lein kibit</code> found:</p>

<script src="https://gist.github.com/mathias/fc0d446aeb90f44a6731.js"></script>


<p>These kinds of small improvements are all over our Clojure projects. They&#8217;re not show-stopper bugs, but they&#8217;re small places for improvement.</p>

<p>Kibit&#8217;s suggestions are almost always logically equivalent to the original code. Still, I always do some smoke-testing to ensure the code still works after using Kibit&#8217;s suggestion, and it generally does. Problems I frequently fix with Kibit are replacing <code>if</code> statements with the <code>when</code> macro, as well as places where the code checks for empty seqs, or that I can simplify nil checks.</p>

<p>You can point lein kibit at a specific namespace by appending the path, like this: <code>lein kibit src/foo/bar.clj</code></p>

<p>Kibit catches many cases where there is a more-idiomatic way to express what you are trying to do. I recommend running it often. In fact, it&#8217;s possible to use <a href="https://github.com/jonase/kibit#usage-from-inside-emacs">kibit in your emacs buffers</a> if you want it to be that much more convenient and real-time.</p>

<h2><a href="https://github.com/jonase/eastwood">Eastwood</a></h2>

<p>For linting Clojure code, there&#8217;s Eastwood. It is similar in functionality to Kibit, bit will catch different issues than Kibit. Built on two interesting Clojure projects: <a href="https://github.com/clojure/tools.analyzer">tools.analyzer</a> and <a href="https://github.com/clojure/tools.analyzer.jvm">tools.analyzer.jvm</a>, Eastwood does a powerful examination of your code inside the JVM. It is worth highlighting that since Eastwood loads your code to analyze it, it might trigger any side effects that happen when your code loads: writing files, modifying databases, etc. Note that it only loads the code; it does not execute it.</p>

<p>After adding <code>eastwood</code> to your lein <code>profiles.clj</code>, simply run: <code>lein eastwood</code> and you will see output like:</p>

<script src="https://gist.github.com/mathias/b93cea02293eac933bee.js"></script>


<p>That&#8217;s a lot of problems for a simple file! Notice how one mistake got caught for two reasons: A misplaced docstring (placed after the arguments vector) becomes just a string in the function body that will be thrown away.</p>

<p>Another nice catch that Eastwood provides is detecting the redefinition of the var <code>qux</code> in the file.</p>

<p>But Eastwood covers a lot more cases than just vars being def&#8217;d more than once. See the <a href="https://github.com/jonase/eastwood#whats-there">full list</a> to find out what else it does. There&#8217;s a few linters that are disabled by default, but they might make sense to enable for your project.</p>

<p>Frequently running lint tools can help prevent subtle problems that come from code that looks correct but contains some small error. Eastwood is less concerned with style than tools like JSHint are, but we have other tools that cover stylistic concerns.</p>

<h2><a href="https://github.com/dakrone/lein-bikeshed">lein bikeshed</a></h2>

<p>This is a relative newcomer to my own tool set. <a href="https://github.com/dakrone/lein-bikeshed">lein bikeshed</a> has features related to the low-hanging fruit in our Clojure code: lines longer than 80 characters, blank lines at ends of files, and more. It will also tell you what percentage of functions have docstrings. Like other tools mentioned here, it is a lein plugin that you add to your <code>profiles.clj</code>.</p>

<p>A run of <code>lein bikeshed</code> on its own source (which purposefully includes some code designed to fail) looks like this:</p>

<script src="https://gist.github.com/mathias/271e06ebce8fe6428b83.js"></script>


<p>Bikeshed might give a lot of output for your existing projects, but the warnings are worth investigating and addressing. You can always silence the long-lines warning if it doesn&#8217;t matter to you with the <code>-m</code> command line argument.</p>

<h2>Tying it all together with a Lein alias</h2>

<p>Wouldn&#8217;t it be great to run all these tools frequently, so that you can check for as many problems as possible? Well, you can, with a lein alias. (The lein wiki documents aliases in the <a href="https://github.com/technomancy/leiningen/blob/stable/sample.project.clj#L195-L211">lein sample.project.clj</a>.)</p>

<p>In <code>~/.lein/profiles.clj</code>, inside your <code>:user</code> map, add the line:</p>

<script src="https://gist.github.com/mathias/eef9f3f3e9e0ba40cb78.js"></script>


<p>Now, when you want to run all these tools at once on a project, you simply invoke <code>lein omni</code>. I use this alias on all my Clojure(Script) projects. I have grown accustomed to seeing the kinds of output that a clean Clojure project will have.</p>

<p>It&#8217;s worth noting that I don&#8217;t run Eastwood unless it is necessary for the project. When it is necessary, I override the alias in the project&#8217;s <code>project.clj</code> to run Eastwood as well.</p>

<p>This command can take some time to complete, but with an alias we&#8217;re only spinning up lein once.</p>

<h2>And a bash alias</h2>

<p>The output of <code>lein omni</code> can be long, which can either result in a lot of scrolling or neglecting to run the command due to the inconvenience. To help manage the length of the output, I&#8217;ve created a bash alias that runs the plugins and pipes them to less.</p>

<p>My personal bash alias also runs midje at the end. You can choose whether to run the tests for your own alias. That&#8217;s just my personal preference.</p>

<script src="https://gist.github.com/mathias/8b6a0040fcd7e4ae890f.js"></script>


<p>Note that just like running the lein alias above, this may take a bit of time. Since we&#8217;re piping it to <code>less</code>, it might take awhile before <code>less</code> receives output. While it is still running, output will periodically show up at the bottom of the <code>less</code> buffer. You can use both Emac&#8217;s and vim&#8217;s movement commands in <code>less</code> to advance the buffer. I find <code>less</code> to be more manageable for scrolling through output than switching to <code>tmux</code>&#8217;s history scrolling mode.</p>

<h2>Managing your namespaces: <a href="https://github.com/technomancy/slamhound">lein slamhound</a></h2>

<p>Namespace management often becomes an issue on nontrivial Clojure projects. Actively developing a project means managing the functions we pull in from other namespaces and from libraries. These require statements can often get out of date. Often, they&#8217;re either missing namespaces that are needed, or containing requirements for old functions that are no longer used in the current code.</p>

<p><a href="https://github.com/technomancy/slamhound">slamhound</a> is a tool that can help to manage dependencies in your namespaces. It knows how to require and import Clojure and Java dependencies, and can remove stale requires that are no longer necessary. Slamhound can often fix missing requires for functions that it can resolve.</p>

<p><strong>Note: slamhound rewrites the namespace macros in your project&#8217;s .clj files!</strong> I recommend only running it on code that&#8217;s committed to git (or whatever you use as a VCS) so that you can review and  rollback any changes it makes.</p>

<p>The most basic way to use slamhound is to add it to your <code>~/.lein/profiles.clj</code> as a dependency. Then add this alias:</p>

<script src="https://gist.github.com/mathias/f3799e60c63b0aebf17e.js"></script>


<p>Now you can use slamhound on a project by running <code>lein slamhound</code> in the project&#8217;s directory. There&#8217;s also REPL and Emacs support, which you can learn more about in the <a href="https://github.com/technomancy/slamhound#repl-usage">slamhound README</a>.</p>

<h2>Measuring test coverage with <a href="https://github.com/lshift/cloverage">cloverage</a></h2>

<p>It is often claimed that less unit testing is necessary in Clojure because Clojure is functional and makes use of immutable data structures. And it is true that with functional programming, most tests are simple: given some input, the output should be a certain value.</p>

<p>Some would even argue that Clojure functions should be well-factored enough into simple functions that the behavior of the function is apparent and requires no tests. Still others maintain that developing in the REPL is as good as writing unit tests, since functions are constantly evaluated and integrated with this style of development.</p>

<p>That said, there&#8217;s still mutable Java code to interop with, there&#8217;s still the necessary evil of functions with side effects, and we might want to check the <em>structure</em> of the data we&#8217;re producing in our functions rather than the value of it. For all those reasons and to check that I don&#8217;t introduce regressions, I tend to write unit tests in Clojure.</p>

<p>This blog post isn&#8217;t a platform to argue for or against testing Clojure. But when you do test, you may wonder how to tell how much test coverage your test suite has. How do we know at a glance what percentage of our namespaces is being tested? And how do we find lines that are never being exercised in our tests? After all, we can&#8217;t improve what we don&#8217;t measure.</p>

<p>That&#8217;s where <a href="https://github.com/lshift/cloverage">cloverage</a> comes in. Cloverage is another lein plugin, so it gets added to <code>~/.lein/profiles.clj</code> like the others. Then run <code>lein cloverage</code> in your project; it will run the test suite and generate a coverage report.</p>

<p>The coverage report appears in <code>target/coverage</code> as HTML files, broken down by namespace.</p>

<p>You can still use Cloverage even if you don&#8217;t use <code>clojure.test</code>. I use <a href="https://github.com/marick/Midje">midje</a> in most of my tests. To use Cloverage in those situations, wrap your tests in a <code>deftest</code>.</p>

<p>Since <code>deftest</code> has a hyphenated Clojure keyword as its identifier, and Midje facts have a string as an identifier, I&#8217;ve come to use the <code>deftest</code> to group related tests together. Usually this means naming the group of tests after the function I&#8217;m testing. Then I name Midje facts after the situation that the fact exercises. This makes sense to me because it fits well with the hierarchy of rspec unit tests in Ruby.</p>

<p>Here&#8217;s an example of using this approach:</p>

<script src="https://gist.github.com/mathias/94e1a4d7b8bce7c02e23.js"></script>


<p>Cloverage also outputs a <code>coverage.txt</code> file that might be useful for use with services like <a href="http://coveralls.io">Coveralls</a>. I haven&#8217;t used this, so I can&#8217;t comment on its usefulness.</p>

<p>If you&#8217;re using <a href="https://github.com/slagyr/speclj">speclj</a> for your tests, you might run into some issues getting Cloverage to play nice. I don&#8217;t use speclj often, so when I couldn&#8217;t get it to work with Cloverage, I didn&#8217;t pursue the issue.</p>

<h2>Final Thoughts</h2>

<p>In this post, I covered 5 tools to add to your workflow all the time, and some others that might be useful in certain cases. I&#8217;m sure there&#8217;s more tools out there that are useful that I don&#8217;t know about, and I&#8217;d love to hear about them.</p>

<p>I&#8217;m also thinking about writing some posts about other development tools that I use, particularly how I use <a href="https://github.com/marick/midje">midje</a> to test, and how you can benchmark code with <a href="https://github.com/davidsantiago/perforate">perforate</a>. If you&#8217;re interested in those topics, get in touch and let me know.</p>

<p>Have fun and enjoy your cleaner codebase with these tools in your tool belt!</p>

<hr />

<p>Interested in commenting or contacting me? Send an email to <a href="mailto:contact@mattgauger.com">contact@mattgauger.com</a>. Thanks!</p>

        
        
    </div>

    <div class="meta">
        <div class="author">
  

<span class="byline author vcard">Posted by <span class="fn">Matt Gauger</span>.</span>
</div>
        <div class="date">












<time datetime="2014-09-15T13:39:00-05:00" pubdate  data-updated="true" >Sep 15<span>th</span>, 2014</time>.</div>
        <div class="tags">

</div>
    </div>

  </article>


  <article class="post">
    
    <h1 class="title"><a href="/blog/2014/08/19/atreus-my-custom-keyboard/">Atreus: My Custom Keyboard</a></h1>
    <div class="entry">
        <p>Last year I wrote about about building <a href="/blog/2013/08/03/building-a-chording-keyboard-lessons-learned-and-progress-so-far/">chording keyboards</a> and <a href="/blog/2013/08/06/a-simple-text-editor-foot-pedal/">USB foot pedals</a>. At the time, using the <a href="http://www.pjrc.com/teensy/">Teensy micro controller</a> as a USB HID device was possible, but it still required a lot of research. There was no good central resource for knowledge about building keyboards. Since then, the <a href="http://deskthority.net/wiki/ErgoDox">Ergo Dox</a> keyboard was released as open source and got quite popular. This seems to have opened the door for many to get into building keyboards.</p>

<iframe class="vine-embed" src="https://vine.co/v/M9xtVUQ2O7O/embed/simple" width="320" height="320" frameborder="0" style="float:right;"></iframe>


<script async src="//platform.vine.co/static/scripts/embed.js" charset="utf-8"></script>


<p>My friend <a href="http://coglib.com/~icordasc">Ian</a> ordered an Ergo Dox on the Massdrop crowdfunding campaign, after I suggested that I&#8217;d teach him to solder and we&#8217;d assemble it together. Finding time to get together and build it took almost a year, but we&#8217;ve started meeting up weekly to assemble the Ergo Dox. Building his keyboard has been a lot of fun, and inspired me to work on my own keyboard projects again.</p>

<p>Almost exactly a month ago, I started working on building my own keyboard. I wanted to build a keyboard from scratch that could replace my daily-driver keyboard, a PFU Happy Hacking Lite, so it had to be smaller than most <a href="http://deskthority.net/wiki/Tenkeyless">tenkeyless</a> keyboards. The Ergo Dox&#8217;s columnar layout was always intriguing, but I wasn&#8217;t sure that I needed all those keys. (Normal keyboards stagger the keys of each row, which is a holdover from preventing mechanical typewriters from jamming. Columnar layouts assign a column of keys to each finger.)</p>

<p>Through <a href="http://geekhack.org">Geekhack</a>, I found the <a href="https://github.com/technomancy/atreus">Atreus</a>, a keyboard designed by <a href="http://technomancy.us/">Phil Hagelberg</a> (better known as <a href="https://github.com/technomancy">technomancy</a> online.) The Atreus is open source (<a href="https://github.com/technomancy/atreus">hardware</a>, <a href="https://github.com/technomancy/atreus-firmware">firmware</a>), and has gone through several revisions at this point. My keyboard is done now, and I wanted to share it.</p>

<p><a href="https://www.flickr.com/photos/mattgauger/14785511628" title="IMG_3220 by Matt Gauger, on Flickr"><img src="https://farm6.staticflickr.com/5592/14785511628_5827e18f92_z.jpg" width="640" height="480" alt="IMG_3220"></a></p>

<p><a href="http://technomancy.us/173">The original Atreus</a> was constructed out of layers of laser-cut acrylic. Since then, some folks on the <a href="http://geekhack.org/index.php?topic=54759.0">Geekhack thread</a> have redesigned the laser-cut design to be cut out of a sheet of birch plywood on <a href="https://ponoko.com">Ponoko</a>. Ponoko is a great: you upload a file and choose materials and size. The Ponoko website keeps you updated on your project&#8217;s status as they check your design, pick materials, and so on. Later, your laser-cut project arrives in the mail. I highly recommend Ponoko&#8217;s service if you need laser cutting and can&#8217;t get it done at a local makerspace.</p>

<p><a href="https://www.flickr.com/photos/mattgauger/14785346149" title="IMG_3156 by Matt Gauger, on Flickr"><img src="https://farm6.staticflickr.com/5565/14785346149_ece2db51a3_z.jpg" width="640" height="480" alt="IMG_3156"></a></p>

<p>I finished the birch ply with semi-gloss marine polyurethane. The polyurethane should give it a durable finish, and added a nice amber tint to the wood. The downside is that more than a week after the final coat went on, the poly is still out gassing some headache-inducing fumes.</p>

<p>After applying the finish, I hot-glued the switches in and soldered it together. There&#8217;s no PCB with this design, just point-to-point with wires and components to a central Teensy. I used <a href="http://deskthority.net/wiki/Cherry_MX_Clear">Cherry MX Clear</a> switches for the majority of the keys because they seem the closest to my Happy Hacking&#8217;s Topre switches to me. The modifiers are <a href="http://deskthority.net/wiki/Cherry_MX_Black">Cherry MX Blacks</a>.</p>

<p>Assembling the Atreus with point-to-point soldering wasn&#8217;t too bad, but I&#8217;ve had a lot of experience soldering. I&#8217;ve no doubt that the construction will be durable and reliable, but a PCB might make it easier to assemble for beginners. There&#8217;s some talk on Geekhack about using the <a href="http://deskthority.net/workshop-f7/onehand-20-keyboard-t6617.html">One Hand PCB</a> as a circuit board for a Atreus-like keyboard.</p>

<p>The rest of my images from the build on Flickr in <a href="https://www.flickr.com/photos/mattgauger/sets/72157646763805951/">this album</a>.</p>

<p>After hours of soldering, the moment of truth came: I plugged in the Teensy, uploaded the firmware, and typed some keys. It worked! I felt relieved that the keyboard worked on the first try. Because I had checked for continuity and shorts throughout the soldering process, I can be confident that my Atreus won&#8217;t have any issues with ghosting or glitches. The finished keyboard feels really solid; maybe more so than some plastic keyboards I&#8217;ve typed on before.</p>

<p>Because the Atreus uses a columnar layout, I&#8217;m not planning to use it with a QWERTY layout. So, I decided to learn Dvorak. I&#8217;ve been practicing on the home row on <a href="http://dvorak.nl">dvorak.nl</a>, which is a great website for learning Dvorak in your browser. The neat thing about that typing tutor is that you don&#8217;t have to commit to changing any key layouts at the OS-level. I&#8217;ve got the default QWERTY layout on my Atreus now, but will be switching to a hardware-native Dvorak layout soon.</p>

<p>Since the Atreus uses a Teensy as its brain, it can be reconfigured easily by uploading a new firmware. Keyboard layouts for the Atreus start as a JSON file, and then an emacs function can be invoked to compile and upload the firmware to the board. The same JSON file can also be used to generate an HTML table of the layout with Org Mode in emacs. More information can be found on the <a href="https://github.com/technomancy/atreus-firmware">firmware project repo</a>.</p>

<h2>What next?</h2>

<p>I haven&#8217;t worked on my chording keyboard in a long time.  I&#8217;m happy to see that things like the <a href="https://github.com/tmk/tmk_keyboard">tmk firmware</a> will now make that project much easier. With my new knowledge and the many open source projects now available, I&#8217;m going to restart work on <a href="/blog/2013/08/03/building-a-chording-keyboard-lessons-learned-and-progress-so-far/">that project</a>.</p>

<p>Further, I&#8217;ve been playing with Matt Adereth&#8217;s <a href="https://github.com/adereth/dactyl">dactyl</a> to design chording keyboard layouts. Dactyl allows me to write Clojure code and output it in a format that OpenSCAD can generate a 3D model with. OpenSCAD can export the files to the formats that 3D printers use. 3D printing has a lot of promise for iteratively prototyping unique ergonomic peripherals, and I intend to try out several ideas for one-hand / chording keyboards.</p>

<p>If you&#8217;re interested in building your own keyboard, I would recommend the Ergo Dox. Especially if you can get the kit that Massdrop produced, because the circuit boards are well-made. Otherwise, spend some time on the Geekhack &amp; Deskthority forums, read some wiki pages, and test some keyboards. And if you&#8217;re interested in building the Atreus, join the <a href="http://geekhack.org/index.php?topic=54759.0">discussion</a>! Everyone in that thread has been very helpful.  This project wouldn&#8217;t have been possible without their answers and advice.</p>

<hr />

<p>Interested in commenting or contacting me? Send an email to <a href="mailto:contact@mattgauger.com">contact@mattgauger.com</a>. Thanks!</p>

        
        
    </div>

    <div class="meta">
        <div class="author">
  

<span class="byline author vcard">Posted by <span class="fn">Matt Gauger</span>.</span>
</div>
        <div class="date">












<time datetime="2014-08-19T21:38:00-05:00" pubdate  data-updated="true" >Aug 19<span>th</span>, 2014</time>.</div>
        <div class="tags">

</div>
    </div>

  </article>


  <article class="post">
    
    <h1 class="title"><a href="/blog/2014/07/27/housekeeping-imported-coderwall-protips/">Housekeeping: Imported Coderwall Protips</a></h1>
    <div class="entry">
        <p>As part of my continuing effort to archive content I&#8217;ve created to this blog, I&#8217;ve migrated all of <a href="https://coderwall.com/p/u/mathias">my Coderwall protips</a>.</p>

<p>Here&#8217;s a quick list of the posts:</p>

<ul>
<li><a href="http://blog.mattgauger.com/blog/2013/11/14/indent-and-colorize-html-strings-in-pry/">Indent and Colorize HTML Strings in Pry</a> <em>November 14, 2013.</em></li>
<li><a href="http://blog.mattgauger.com/blog/2013/09/03/git-fml/">git fml</a> <em>September 3, 2013.</em></li>
<li><a href="http://blog.mattgauger.com/blog/2013/07/27/minskys-circle-algorithm-in-shoes-dot-rb-slash-hackety-hack/">Minsky&#8217;s Circle Algorithm in Shoes.rb / Hackety Hack</a> <em>July 27, 2013.</em></li>
<li><a href="http://blog.mattgauger.com/blog/2013/05/23/warning-nokogiri-was-built-against-libxml-version-x-dot-x-x/">WARNING: Nokogiri Was Built Against LibXML Version x.x.x</a> <em>May 23, 2013.</em></li>
<li><a href="http://blog.mattgauger.com/blog/2013/04/24/reset-a-lost-password-on-an-ubuntu-vm/">Reset a Lost Password on an Ubuntu VM</a> <em>April 24, 2013.</em></li>
<li><a href="http://blog.mattgauger.com/blog/2013/01/24/find-naughty-naughty-model-calls-in-your-views/">Find Naughty Naughty Model Calls in Your Views</a> <em>January 24, 2013.</em></li>
<li><a href="http://blog.mattgauger.com/blog/2012/12/25/find-a-unique-name-for-your-project/">Find a Unique Name for Your Project</a> <em>December 25, 2012.</em></li>
</ul>


        
        
    </div>

    <div class="meta">
        <div class="author">
  

<span class="byline author vcard">Posted by <span class="fn">Matt Gauger</span>.</span>
</div>
        <div class="date">












<time datetime="2014-07-27T12:05:00-05:00" pubdate  data-updated="true" >Jul 27<span>th</span>, 2014</time>.</div>
        <div class="tags">

</div>
    </div>

  </article>


  <article class="post">
    
    <h1 class="title"><a href="/blog/2014/04/13/clojure-data-science-refactoring-and-cleanup/">Clojure Data Science: Refactoring and Cleanup</a></h1>
    <div class="entry">
        <hr />

<p>This is Part 2 of a series of blog posts called <a href="/blog/categories/clojure-data-science">Clojure Data Science</a>. Check out the <a href="/blog/2014/03/30/clojure-data-science-ingesting-your-gmail-inbox/">previous post</a> if you missed it.</p>

<hr />

<p>Welcome to the second post in this series. If you followed along in the last post, your code should be ready to use in this post. If not, or if you need to go back to known working state, you can clone the <a href="https://github.com/mathias/autodjinn">autodjinn repo</a> and <code>git checkout v0.1.0</code>.</p>

<p>I started out writing this post to develop simple functionality on our inbox data. Finishing the post was taking longer than I was expecting, so I split the post in half in the interest of posting this sooner.</p>

<p>In this post, we need to create an email ingestion script that we can run repeatedly with <code>lein</code>. And we need to talk about refactoring our code out into maintainable namespaces.</p>

<p>So make sure your Datomic transactor is running and launch a REPL, because it is time to give our code a makeover.</p>

<h2>A Gmail ingestion script</h2>

<p>Because Clojure sits on the JVM, it shares some similarities with Java. One of these is the special purpose of a <code>-main</code> function. You can think of this as the <code>main</code> method in a Java class. The <code>-main</code> function in a Clojure namespace will be run when a tool like <code>lein</code> tries to &#8220;run&#8221; the namespace. That sounds like exactly what we want to do with our Gmail import functionality, so we will add a <code>-main</code> function that calls our <code>ingest-inbox</code> function. To get started, we will only have it print us a message.</p>

<script src="https://gist.github.com/mathias/9965864.js"></script>


<p>You can then run this by invoking <code>lein run -m autodjinn.core</code>. You should see <code>Hello world!</code> if everything worked. You may notice that the process doesn&#8217;t seem to quit after it prints the hello world message &#8211; this seems to be problem with Leiningen. To ensure that our process ends when the script is done, we can add a <code>(System/exit 0)</code> line to the end of our <code>-main</code> function to ensure that the process quits normally. On *nix systems, a 0 return code means successful exit, and a nonzero response code means something went wrong. Knowing this, we can take advantage of response codes in the future to signal that an error occurred in our script. But for now, we will have the script end by returning 0 to indicate a successful exit.</p>

<p>Think back to what we did to ingest email in our REPL in the last post. We had to connect to the database, run the data schema transaction, and then we were able to run <code>ingest-inbox</code> to pull in our email.</p>

<p>The following function will do the same thing. Remember that things like trying to create an existing database or performing a schema update against the same schema in Datomic should be harmless. It will add a new transaction ID, but it will not modify or destroy data. Putting together all the steps we need to run, we get a <code>-main</code> function that looks like this:</p>

<script src="https://gist.github.com/mathias/9965933.js"></script>


<h2>Refactoring namespaces</h2>

<p>With Clojure, one must walk a fine line between putting all of your functions into one big file, and having too many namespaces. One big file quickly grows unmaintainable and gains too many responsibilities.</p>

<p>But having too many namespaces can also be a problem. It may create strange cyclic dependency errors. Or you may find that with many separate namespaces, you have to require many namespaces to get anything done.</p>

<p>To avoid this, I start with most code in one namespace, and then look for common functionality to extract to a new namespace. Good candidates to extract are those that all talk about the same business logic or business domain. You may notice that the responsibility for one group of functions is different than the rest of the functions. That is a good candidate for a new namespace. Looking at responsibilities can be a good way to determine where to break apart functions into namespaces.</p>

<p>In this project, we can identify two responsibilities that currently live in our autodjinn.core namespace. The first is working with the database. The second is ingesting Gmail messages. As our project grows, we will not want the code for ingesting Gmail messages to live in <code>autodjinn.core</code>. With that in mind, let&#8217;s create a new file called <code>src/autodjinn/gmail_ingestion.clj</code> and move over the vars and functions that we think should live there. That file should look like this:</p>

<script src="https://gist.github.com/mathias/9966207.js"></script>


<p>Be sure to remove the functions and vars that we moved to this file from the <code>autodjinn.core</code> namespace. Note that we moved the <code>-main</code> function here, too, so that we can now run <code>lein run -m autodjinn.gmail-ingestion</code></p>

<p>You may also notice that we still had to require the <code>datomic.api</code> namespace here to be able to perform a transaction. Our <code>autodjinn.core</code> namespace already handles database interaction, though. So let&#8217;s write a <code>create-mail</code> function in <code>core.clj</code> and call it in our new namespace:</p>

<script src="https://gist.github.com/mathias/9966294.js"></script>


<p>And in <code>gmail_ingestion.clj</code> we change <code>ingest-inbox</code> to use the new function. While we&#8217;re at it, we&#8217;ll break out a convenience function to prepare the attr map for Datomic:</p>

<script src="https://gist.github.com/mathias/9966304.js"></script>


<p>If we run our <code>lein run -m autodjinn.gmail-ingestion</code> command, we should see that the code is still working.</p>

<p>Don&#8217;t forget to remove the <code>datomic.api</code> requirement in <code>gmail-ingestion</code> namespace! Now we only need to require Datomic in the <code>autodjinn.core</code> namespace.</p>

<p>There&#8217;s one more low-hanging fruit that we can refactor about this code before moving on. The config file is loaded and used in both namespaces. We already require everything from <code>autodjinn.core</code> into <code>autodjinn.gmail-ingestion</code>. So we can safely change a few lines to use the config in <code>gmail_ingestion.clj</code> and stop requiring <code>nomad</code> in two places:</p>

<script src="https://gist.github.com/mathias/9966372.js"></script>


<p>And in <code>core.clj</code>:</p>

<script src="https://gist.github.com/mathias/9966384.js"></script>


<p>Running <code>lein run -m autodjinn.gmail-ingestion</code> one more time, we should see that our changes did not break the system. The config is now only loaded once, and we use it everything.</p>

<p>That&#8217;s it! We&#8217;ve taken care of some low-hanging fruit and are ready to implement some new functionality. If you want to compare what you&#8217;ve done with my version, you can run <code>git diff v0.1.1</code> on the <a href="https://github.com/mathias/autodjinn">autodjinn repo</a>.</p>

<p>Please let me know what you think of these posts by sending me an email at <a href="mailto:contact@mattgauger.com">contact@mattgauger.com</a>. I&#8217;d love to hear from you!</p>

        
        
    </div>

    <div class="meta">
        <div class="author">
  

<span class="byline author vcard">Posted by <span class="fn">Matt Gauger</span>.</span>
</div>
        <div class="date">












<time datetime="2014-04-13T16:28:00-05:00" pubdate  data-updated="true" >Apr 13<span>th</span>, 2014</time>.</div>
        <div class="tags">

</div>
    </div>

  </article>


<ul class="pager">
  
  
    <li>
    <a href="/blog/page/2/" class="next">Next</a>
    </li>
  
</ul>

<a href="/blog/archives" class="center">
  <i class="icon-th-list"></i> 
  Blog Archives
</a>

  </article>
</div>

    <hr />
	  <footer class="footer"><div class="row">
  <div class="offset2 span2">
    <img src="/images/mathiasx.jpg" alt="portrait">
  </div>
  <div class="span3">
    <p><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img src="https://github-camo.global.ssl.fastly.net/cc898278e77203243a0b63be665d38fa75dcf04a/687474703a2f2f692e6372656174697665636f6d6d6f6e732e6f72672f6c2f62792d6e632d73612f332e302f38387833312e706e67" alt="Creative Commons License Image" data-canonical-src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" style="max-width:100%;"></a>
blog.mattgauger.com
by <a href="http://blog.mattgauger.com">Matt Gauger</a> is licensed under a <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons
Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>

  </div>
  <div class="offset1 span3">
    <ul class="nav nav-list">
      <li><a href="https://github.com/mathias">Github</a></li>
      <li><a href="/presentations">Presentations</a></li>
      <li><a href="http://feeds.feedburner.com/MattGaugerBlog" title="Atom XML/RSS Feed">Atom Feed</a></li>
    </ul>
  </div>
</div>
</footer>
  </div>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script src="/javascripts/bootstrap-alert.js"></script>
<script src="/javascripts/bootstrap-button.js"></script>
<script src="/javascripts/bootstrap-collapse.js"></script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38944731-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
